<html><head><meta http-equiv="Content-Type" content="text/html; charset=koi8-r"><title>Примеры из практики.</title><link rel="stylesheet" href="chs/default.css" type="text/css"><meta name="generator" content="DocBook XSL Stylesheets V1.75.1"><link rel="home" href="index.html" title="Краткий учебник по sed."><link rel="up" href="ch04.html" title="Глава 4. Примеры скриптов."><link rel="prev" href="ch04s16.html" title="Восстановление данных и файловая система."><link rel="next" href="ch04s18.html" title="Интерактивная sed."></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">Примеры из практики.</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="ch04s16.html">Пред.</a> </td><th width="60%" align="center">Глава 4. Примеры скриптов.</th><td width="20%" align="right"> <a accesskey="n" href="ch04s18.html">След.</a></td></tr></table><hr></div><div class="section" title="Примеры из практики."><div class="titlepage"><div><div><h3 class="title"><a name="id2526898"></a>Примеры из практики.</h3></div></div></div><div class="section" title="Замена некоторых символов в некоторых выбранных подстроках."><div class="titlepage"><div><div><h4 class="title"><a name="id2526903"></a>Замена некоторых символов в некоторых выбранных подстроках.</h4></div></div></div><p>
				Часто нужно заменить не все символы в строке, а только некоторые, те, что попадают под заданное регулярное выражение. К примеру, недавно мне потребовалось заменить выражение /%5B/ на скобку <span class="quote">&#171;<span class="quote">[</span>&#187;</span>, но не везде, а лишь НЕ внутри ED2K ссылок. Как это сделать?
			</p><p>
				Ясно, что простая команда <span class="command"><strong>s</strong></span> тут не применима, следует воспользоваться каким-то другим приёмом, лично я использовал технику маркёров - я попросту стёр все места где замена не требуется, и вместо них вставил туда маркёрные байты. После чего и произвёл замену:<span class="command"><strong>s/%5B/[/g;	s/%5D/]/g</strong></span> Как видите - всё просто. Команда удаления тех мест, где замена не нужна тоже тривиальна: <span class="command"><strong>s~\[url=ed2k://[^]]+\]~\r~ig</strong></span> (подразумевается, что мы уже очистили текст от <span class="quote">&#171;<span class="quote">\r</span>&#187;</span>).
			</p><p>
				Теперь нам нужно поменять маркёры на нужные подстроки. Сделать это не так уж и сложно, проблема лишь в их очерёдности. В силу того, что регулярное выражение /.*МАРКЁР/ захватывает все маркёры до последнего, проще всего как раз с последнего и начать, и заменить их все в цикле, я это сделал так:
				</p><pre class="programlisting">:l4
	# вставляем последнюю ссылку на своё место в цикле
	s~^(.*)\r([^\n]*)\n(.*)(\[url=ed2k://[^]]+\])(.*)$~\1\4\2\n\3\5~i
	t l4</pre><p>
Как видите, ничего архисложного - тут у меня два особых символа: <span class="quote">&#171;<span class="quote">\r</span>&#187;</span> я использую в качестве маркёра, а вот <span class="quote">&#171;<span class="quote">\n</span>&#187;</span> используется в качестве разделителя. В выражении для поиска дважды встречается /.*/ - мы ищем именно последнее совпадение (третье вхождение /.*/ я не считаю - это просто хвост, который надо сохранять).
			</p><p>
				Безусловно, я приведу и весь скрипт целиком:
				</p><pre class="programlisting">/%5B|%5D/{
	#замена скобок обратно. Заменяются только вне bbcode
	\~\[url=ed2k://~{
		# у нас есть ed2k ссылки, сохраняем строку
		h
		# вырезаем ссылки
		s~\[url=ed2k://[^]]+\]~\r~ig
		# меняем скобки и палки
		s/%5B/[/g
		s/%5D/]/g
		# добавляем старую строку
		G
		t l4
		:l4
			# вставляем последнюю ссылку на своё место в цикле
			s~^(.*)\r([^\n]*)\n(.*)(\[url=ed2k://[^]]+\])(.*)$~\1\4\2\n\3\5~i
			t l4
		# отрезаем ненужный хвост
		s/\n.*//
		b l5
	}
	s/%5B/[/g
	s/%5D/]/g
	:l5
}
</pre><p>
			</p></div><div class="section" title="Ещё один способ замены некоторых подстрок в выбранных подстроках. При использовании мультистрочного текста."><div class="titlepage"><div><div><h4 class="title"><a name="id2527047"></a>Ещё один способ замены некоторых подстрок в выбранных подстроках. При использовании мультистрочного текста.</h4></div></div></div><p>
				Недавно мне попалась похожая с прошлым примером задача: имелась большая строка (1-50Кбайт), которая представляет собой некий текст. Этот текст вообще говоря являлся HTML текстом, но с некоторым исключением: в обычном HTML все последовательности пробельных символов (<span class="quote">&#171;<span class="quote"> </span>&#187;</span>, <span class="quote">&#171;<span class="quote">\t</span>&#187;</span>, <span class="quote">&#171;<span class="quote">\r</span>&#187;</span>, и <span class="quote">&#171;<span class="quote">\n</span>&#187;</span>) эквивалентны одному пробелу, но есть и исключение:
			</p><p>
				Некоторый текст можно заключить в теги &lt;pre&gt;&lt;/pre&gt;, и тогда этот текст должен быть выведен "как есть". Моя задача была преобразовать этот HTML в текст, причём ограничителем "кода" выступало очень сложное регулярное выражение (скорее очень громоздкое). И кроме того, я не мог использовать символ <span class="quote">&#171;<span class="quote">\n</span>&#187;</span> в качестве разделителя.
			</p><p>
				Для начала я стёр 2 символа, которые я решил использовать в качестве маркёров:
				</p><pre class="programlisting">
s/@/&lt;а&gt;/g
s/~/&lt;я&gt;/g
				</pre><p>
				(обратите внимание: буква <span class="quote">&#171;<span class="quote">а</span>&#187;</span> тут русская!)
			</p><p>
				Теперь я имею 2 маркёрных символа, чего мне вполне хватит (именно эти символы были выбраны потому, что они не являются метасимволами regex'пов, и их не надо экранировать). Теперь я могу заменить начальные и конечные части выражения на маркёры:
				</p><pre class="programlisting">
s~BEGIN~@&lt;код&gt;~g
s%END%&lt;/код&gt;~%g
				</pre><p>
				</p><div class="note" title="Замечание" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Замечание</h3>
					Словом BEGIN обозначено начало особого участка, словом END - его конец, и также вводятся фиктивные теги для ограничения границ участка, они впоследствии будут заменены.
				</div><p>
			</p><p>
				Получается вот что:
				</p><pre class="screen">
текст1@код1~текст2@код2~текст3
				</pre><p>
				Теперь, когда участки огорожены, я могу сделать копию строки, и отредактировать её участки по отдельности. Пользуясь тем, что в каждой из двух копий я могу попросту стереть ненужные участки:
				</p><pre class="programlisting">
h
s/@[^~]*~/@/g
# обработка обычного текста
x
s/^/~/
s/$/@/
s/~[^@]*@/~/g
# обработка &lt;код&gt;
x
				</pre><p>
				Тут я в обычном тексте меняю куски "кода" на @, а в "коде" меняю обычный текст на ~. Кроме того, в "коде" я ещё и добавляю в начале и в конце строки (точнее всего текста, я уже говорил, он у меня целиком в буфере) символ ~.
			</p><p>
				Теперь осталось собрать эти два текста воедино. На самом деле это не сложно:
				</p><pre class="screen">
текст1@текст2@текст3
~код1~код2~
				</pre><p>
				Как и в прошлом примере, объёденим строчки, но в данном примере нам ещё нужно удалить лишний символ перевода строки (его втоматически добавляет команда <span class="command"><strong>G</strong></span>).
				</p><pre class="programlisting">
G
s/\n~/~/
				</pre><p>
				(тут используется тот факт, что в строке с "текстом" заведомо нет символов ~, а команда <span class="command"><strong>s///</strong></span> меняет лишь первое совпадение.
				получаем следующее:
				</p><pre class="screen">
текст1@текст2@текст3~код1~код2~
				</pre><p>
				Осталось заменить <span class="quote">&#171;<span class="quote">@</span>&#187;</span> на выделенный и обработанный "код". Как и в прошлом примере, меняем по одному фрагменту, начиная с последнего. Фрагмент <span class="quote">&#171;<span class="quote">~код</span>&#187;</span> переносится вместо <span class="quote">&#171;<span class="quote">@</span>&#187;</span>.
				</p><pre class="programlisting">
t l8
:l8
	s/^(.*)@([^~]*)(.*)~([^~]*)~$/\1\4\2\3~/
	t l8
s/~$//
T error
/[~@]/ b error
s/&lt;а&gt;/@/g
s/&lt;я&gt;/~/g
				</pre><p>
				После замены остаётся символ ~ в конце строки, который и удаляется. На всякий случай проверяется наличие оставшихся маркёров (хотя их вроде быть не может). Ну и после замены спец-тегов скрипт завершается.
			</p></div><div class="blockquote"><blockquote class="blockquote"><p>
		Вы можете обсудить этот документ на <a class="ulink" href="http://forum.drbatty.ru/viewtopic.php?f=19&amp;t=5026" target="_top">форуме</a>. Текст предоставляется по лицензии <a class="ulink" href="http://www.gnu.org/licenses/fdl.html" target="_top">GNU Free Documentation License</a> (<a class="ulink" href="http://forum.lorcode.org/viewtopic.php?f=15&amp;t=30" target="_top">Перевод лицензии GFDL</a>).
	</p><p>
		Вы можете пожертвовать небольшую сумму яндекс-денег на счёт <span class="command"><strong>41001666004238</strong></span> для оплаты хостинга, интернета, и прочего. Это конечно добровольно, однако это намного улучшит данный документ (у меня будет больше времени для его улучшения). На самом деле, проект часто находится на грани закрытия, ибо никаких денег никогда не приносил, и приносить не будет. Вы можете мне помочь. Спасибо.
	</p></blockquote></div></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="ch04s16.html">Пред.</a> </td><td width="20%" align="center"><a accesskey="u" href="ch04.html">Уровень выше</a></td><td width="40%" align="right"> <a accesskey="n" href="ch04s18.html">След.</a></td></tr><tr><td width="40%" align="left" valign="top">Восстановление данных и файловая система. </td><td width="20%" align="center"><a accesskey="h" href="index.html">Начало</a></td><td width="40%" align="right" valign="top"> Интерактивная sed.</td></tr></table></div></body></html>
