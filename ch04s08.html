<html><head><meta http-equiv="Content-Type" content="text/html; charset=koi8-r"><title>Изменение регистра букв.</title><link rel="stylesheet" href="chs/default.css" type="text/css"><meta name="generator" content="DocBook XSL Stylesheets V1.75.1"><link rel="home" href="index.html" title="Краткий учебник по sed."><link rel="up" href="ch04.html" title="Глава 4. Примеры скриптов."><link rel="prev" href="ch04s07.html" title="Работа с несколькими строками одновременно (выравнивание текста)."><link rel="next" href="ch04s09.html" title="Ещё один подход к регулировке жадности."></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">Изменение регистра букв.</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="ch04s07.html">Пред.</a> </td><th width="60%" align="center">Глава 4. Примеры скриптов.</th><td width="20%" align="right"> <a accesskey="n" href="ch04s09.html">След.</a></td></tr></table><hr></div><div class="section" title="Изменение регистра букв."><div class="titlepage"><div><div><h3 class="title"><a name="id2522107"></a>Изменение регистра букв.</h3></div></div></div><a name="upper"></a><div class="section" title="Преобразование больших букв в малые."><div class="titlepage"><div><div><h4 class="title"><a name="id2522115"></a>Преобразование больших букв в малые.</h4></div></div></div><p>
				Задача преобразования больших букв в малые решается с помощью команды <span class="command"><strong>s</strong></span> и её префиксов. Например <span class="quote">&#171;<span class="quote">\U</span>&#187;</span> преобразует всё дальнейшие символы в большие, а <span class="quote">&#171;<span class="quote">\L</span>&#187;</span> соответственно в малые. Кроме того используются префиксы <span class="quote">&#171;<span class="quote">\l</span>&#187;</span> и <span class="quote">&#171;<span class="quote">\u</span>&#187;</span>, которые действуют только на первую найденную букву. Для отмены преобразования применяется префикс <span class="quote">&#171;<span class="quote">\E</span>&#187;</span>.
			</p><p>
				Преобразовывать всё не имеет никакого практического смысла, мы будем преобразовывать только СЛОВА ЗАПИСАННЫЕ БОЛЬШИМИ БУКВАМИ. Их вообще-то сначала надо найти. Например таким ERE:
				</p><pre class="programlisting">/\b[A-Z]+\b/</pre><p>
				\b означает "граница слова", и совпадает с позицией между буквой и <span class="emphasis"><em>небуквой</em></span>. Эти границы нужны для того, что-бы преобразовывались только целые СЛОВА.
			</p></div><div class="section" title="Русские буквы."><div class="titlepage"><div><div><h4 class="title"><a name="id2522194"></a>Русские буквы.</h4></div></div></div><p>
				В отличие от утилит вроде tr и языков вроде perl'а, sed умеет работать с русскими буквами в любой кодировке.
				</p><div class="note" title="Замечание" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Замечание</h3>
					Оказывается PERL всё-же умеет UTF-8, только его надо там включить особой командой.
				</div><p>
				Конечно вы должны сначала настроить свою систему на эту кодировку, и использовать либо родную sed (я думаю ваш любимый создатель дистрибутивов встроил в ваш дистрибутив правильно собранную sed), либо собирать sed самостоятельно, не забывая её правильно локализовать. Обычно на всё это не нужно обращать внимание - ваша sed скорее всего уже и так правильно работает в <span class="emphasis"><em>вашей</em></span> системной кодировке. Даже если у вас японская UTF-8 (<span class="quote">&#171;<span class="quote">японская</span>&#187;</span> в том смысле, что вы пользуетесь японским алфавитом).
			</p><p>
				Если кодировка в системе правильно настроена, то sed считает, что спецсимвол \w совпадает с любой буквой. Не только латинской, но и русской. Однако нам нужны слова не из всех букв, а только из БОЛЬШИХ. Диапазон символов не имеет смыла в данном случае, т.к.  во многих кодировках русские буквы идут не подряд. Потому придётся их записывать явно:
				</p><pre class="programlisting">/\b[A-ZАБВГДЕЁЖЗИЙКЛМНОПРСТУФХЦЧШЩЬЫЪЭЮЯ]+\b/</pre><p>
				</p><div class="note" title="Замечание" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Замечание</h3>
					А когда будете записывать позаботьтесь о том, что кодировка скрипта была такой-же как в вашей системе.
					<div class="tip" title="Подсказка" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Подсказка</h3><p>
							Если вам нужно изменить текст в какой-то левой кодировке, то для начала этот документ следует перегнать в вашу кодировку вот так:
							</p><pre class="programlisting">iconv -c -f cp1251 text.txt &gt;text1.txt</pre><p>
							ключ <code class="option">-c</code> нужен для того, что-бы iconv не останавливалась на неправильных символах (которых бывает достаточно много на практике).
						</p><p>
							Впрочем можно и <a class="link" href="ch02s02.html#utf8">изменить переменные окружения</a> так, что-бы sed заработала в какой-нибудь другой кодировке. Конечно сам скрипт тогда надо писать в той-же кодировке, что и ваш текст (а не в системной). Такой подход сложнее, но обработка текста часто происходит намного быстрее. Дело в том, что во многих системах используется кодировка UTF-8, в которой русские буквы занимают 2 байта. Что приводит к тому, что тексты на 50-100% длиннее и обрабатываются соответственно дольше (на те-же 50-100% в лучшем случае).
						</p></div></div><p>
			</p></div><div class="section" title="Использования модификатора g команды s/// с префиксами."><div class="titlepage"><div><div><h4 class="title"><a name="id2522361"></a>Использования модификатора g команды s/// с префиксами.</h4></div></div></div><p>
				Вот так выглядит итоговый скрипт:
				</p><pre class="programlisting">s/\b[A-ZАБВГДЕЁЖЗИЙКЛМНОПРСТУФХЦЧШЩЬЫЪЭЮЯ]+\b/\L\u&amp;/g</pre><p>
				Тут использовано сразу 2 префикса: <span class="quote">&#171;<span class="quote">\L</span>&#187;</span> заменяет все большие буквы на малые, а <span class="quote">&#171;<span class="quote">\u</span>&#187;</span> меняет малые на большие. Фокус в том, что префикс <span class="quote">&#171;<span class="quote">\u</span>&#187;</span> - <span class="emphasis"><em>одноразовый</em></span>, он сбрасывается сразу после замены первой буквы. В отличие от него, префикс <span class="quote">&#171;<span class="quote">\L</span>&#187;</span> никогда сам не сбрасывается. Данный скрипт срабатывает в несколько этапов:
			</p><p>
				Первым делом в строке ищутся все совпадения /RE/ и запоминаются все позиции начала и конца совпадений.
			</p><p>
				И только после полного просмотра всей строки начинаются замены. В данном случае найденное выражение меняется само на себя (используется спец-символ &amp;). Однако во время замены все буквы меняются на малые, а первая меняется дважды - сначала на малую как и все, а потом на большую. Замена производится до конца слова, а вовсе не до конца строки. После замены первого слова начинается замена второго, и т.д..
			</p><p>
				</p><div class="note" title="Замечание" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Замечание</h3>
					Данная задача впервые мне попалась на <a class="ulink" href="http://unixforum.org" target="_top">unixforum'е (бывший LinuxForum)</a>. Тамошние гуру предложили какой-то жуткий скрипт на перле, который я и не понял даже, и выяснили, что с помощью tr это невозможно. Кроме того, советовали воспользоваться vim'ом, который умеет выполнять такие команды (как и более древний ed). Конечно, в данном случае sed - самый лучший способ решения.
				</div><p>
			</p></div><div class="blockquote"><blockquote class="blockquote"><p>
		Вы можете обсудить этот документ на <a class="ulink" href="http://forum.drbatty.ru/viewtopic.php?f=19&amp;t=5026" target="_top">форуме</a>. Текст предоставляется по лицензии <a class="ulink" href="http://www.gnu.org/licenses/fdl.html" target="_top">GNU Free Documentation License</a> (<a class="ulink" href="http://forum.lorcode.org/viewtopic.php?f=15&amp;t=30" target="_top">Перевод лицензии GFDL</a>).
	</p><p>
		Вы можете пожертвовать небольшую сумму яндекс-денег на счёт <span class="command"><strong>41001666004238</strong></span> для оплаты хостинга, интернета, и прочего. Это конечно добровольно, однако это намного улучшит данный документ (у меня будет больше времени для его улучшения). На самом деле, проект часто находится на грани закрытия, ибо никаких денег никогда не приносил, и приносить не будет. Вы можете мне помочь. Спасибо.
	</p></blockquote></div></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="ch04s07.html">Пред.</a> </td><td width="20%" align="center"><a accesskey="u" href="ch04.html">Уровень выше</a></td><td width="40%" align="right"> <a accesskey="n" href="ch04s09.html">След.</a></td></tr><tr><td width="40%" align="left" valign="top">Работа с несколькими строками одновременно (выравнивание текста). </td><td width="20%" align="center"><a accesskey="h" href="index.html">Начало</a></td><td width="40%" align="right" valign="top"> Ещё один подход к регулировке жадности.</td></tr></table></div></body></html>
